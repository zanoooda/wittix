# Job Runner with Bounded Concurrency (Go)

A minimal job runner service in Go that accepts jobs over HTTP, processes them with a bounded worker pool, retries with exponential backoff, enforces per‑job timeouts, and shuts down gracefully.

Current implementation uses a simple in‑memory runner plus optional MongoDB persistence for submitted jobs.

## Features (current)
- Bounded queue (buffered channel) and configurable worker pool.
- Enqueue blocks when the queue is full; honors context cancellation.
- Per‑job timeout (default or per request).
- Exponential backoff with jitter for retries.
- Graceful shutdown on SIGINT/SIGTERM (no worker leaks).
- HTTP endpoints to enqueue and fetch stats.

Note: This branch uses MongoDB (not required by the original “stdlib only” constraint). Results streaming endpoint is not yet implemented.

## Project layout
- `main.go` — HTTP server, MongoDB wiring, configuration, graceful shutdown.
- `runner.go` — runner implementation, worker pool, backoff, stats, demo processor.

## Requirements
- Go 1.22+
- Docker (optional)
- Docker Compose (optional)
- MongoDB (the current server expects it; see docker-compose)

## Quick start

### Run with Docker Compose (Mongo + app)
```bash
docker compose up --build
# App: http://localhost:8080
```

### Run locally (Linux/macOS)
Start MongoDB (e.g., via Docker):
```bash
docker run -d --name job-min-mongo -p 27017:27017 mongo:7
```
Run the app:
```bash
export HTTP_ADDR=":8080"
export MONGO_URI="mongodb://localhost:27017"
export MONGO_DB="jobsdb"
export MONGO_COLL="jobs"
# Optional tuning:
# export WORKERS=4
# export QUEUE_SIZE=64
# export JOB_DEFAULT_TIMEOUT="30s"
# export BACKOFF_BASE="200ms"
# export BACKOFF_MAX="5s"

go run .
```

### Build binary
```bash
go build -o app .
./app
```

### Build container image
```bash
docker build -t job-runner:local .
```

## Configuration (env vars)
- `HTTP_ADDR` — HTTP listen address (default `:8080`)
- `MONGO_URI` — Mongo connection string (default `mongodb://localhost:27017`)
- `MONGO_DB` — Mongo database (default `jobsdb`)
- `MONGO_COLL` — Mongo collection (default `jobs`)
- `WORKERS` — number of worker goroutines (default `4`)
- `QUEUE_SIZE` — queue capacity (default `64`)
- `JOB_DEFAULT_TIMEOUT` — default per‑job timeout (duration string, default `30s`)
- `BACKOFF_BASE` — base backoff (default `200ms`)
- `BACKOFF_MAX` — max backoff cap (default `5s`)
- Jitter is fixed at 0.2 in code (can be adjusted in `main.go`/`runner.go`).

## HTTP API

### POST /jobs
Enqueue a job and persist it to MongoDB.

Request JSON:
```json
{
  "payload": "sleep:2s",
  "timeout": 10,
  "maxRetry": 2
}
```
Notes:
- `timeout` is in seconds (current implementation).
- `id` is autogenerated if missing.
- `payload` demo values:
  - `"sleep:2s"` — simulate work by sleeping
  - `"fail"` — force an error to trigger retries
  - anything else — completes in ~100ms

Response:
- `202 Accepted` with the enqueued job JSON.

Example:
```bash
curl -s -X POST http://localhost:8080/jobs \
  -H 'Content-Type: application/json' \
  -d '{"payload":"sleep:1s","timeout":5,"maxRetry":1}'
```

### GET /stats
Returns runner stats.
Example:
```bash
curl -s http://localhost:8080/stats | jq
```
Response shape (current):
```json
{
  "accepted": 10,
  "inFlight": 1,
  "succeeded": 8,
  "failed": 1,
  "retried": 3,
  "queueLen": 0,
  "queueCap": 64,
  "workers": 4
}
```

### GET /healthz
Liveness probe (returns `200 OK`).

## Processing semantics
- Each job runs under `context.WithTimeout` using either the per‑job timeout (seconds) or the default timeout.
- Retries: exponential backoff doubling each attempt, capped at `BACKOFF_MAX`, with jitter.
- When the service receives SIGINT/SIGTERM, it:
  - stops accepting new jobs,
  - closes the queue,
  - waits for workers to finish,
  - shuts down HTTP gracefully.

## Notes and roadmap to full spec
- Spec asks for stdlib‑only (except gRPC); current code uses MongoDB driver. To comply strictly, remove Mongo usage.
- Spec suggests endpoints `/enqueue`, `/stats` (queued/in_flight/done), and `/results` (NDJSON). Current code exposes `/jobs`, `/stats`, `/healthz`. Add `/results` and adjust shapes if needed.
- Results recording (ID, success, attempts, err, started, ended, duration) not yet persisted or exposed; can be added in `runner.go`.
- Packaging into `cmd/server` + `internal/runner` is recommended for cleanliness.
- Tests to add:
  - enqueue blocking on full queue,
  - per‑job timeouts,
  - retry with backoff,
  - graceful shutdown (no goroutine leaks),
  - race‑free stats/results (`go test -race`).

## Development
Run with race detector:
```bash
go run -race .
```
Format and lint:
```bash
go fmt ./...
```

## License
MIT (or as you prefer)

examples to test

ok
url -s -X POST localhost:8080/jobs \
  -H 'Content-Type: application/json' \
  -d '{"payload":"sleep:1s","timeout":5,"maxRetry":0}' | jq

fail
curl -s -X POST localhost:8080/jobs \
  -H 'Content-Type: application/json' \
  -d '{"payload":"fail","timeout":5,"maxRetry":3}' | jq

fail
curl -s -X POST localhost:8080/jobs \
  -H 'Content-Type: application/json' \
  -d '{"payload":"sleep:2s","timeout":1,"maxRetry":1}' | jq